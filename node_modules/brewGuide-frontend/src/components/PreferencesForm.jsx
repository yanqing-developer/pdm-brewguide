import React from "react";

export default function PreferencesForm({
  prefs,
  setPrefs,
  availableTypes = [],
  onRefreshBreweries,
  onRecommend,
  loading
}) {
  const toggleType = (t) => {
    const key = String(t).toLowerCase();
    const next = new Set((prefs.preferredTypes || []).map((x) => String(x).toLowerCase()));
    if (next.has(key)) next.delete(key);
    else next.add(key);
    setPrefs({ ...prefs, preferredTypes: Array.from(next) });
  };

  const toggleWebsite = () => setPrefs({ ...prefs, preferWebsite: !prefs.preferWebsite });

  const RADIUS_MIN = 1;
  const RADIUS_MAX = 100; // UI cap; backend clamps too.

  const LIMIT_MIN = 1;
  const LIMIT_MAX = 50; // match backend MAX_TOP_N default (recommended)

  const onRadiusChange = (e) => {
    const raw = e.target.value;
    if (raw === "") {
      setPrefs({ ...prefs, radiusKm: RADIUS_MIN });
      return;
    }
    const n = Number(raw);
    if (!Number.isFinite(n)) return;
    const clamped = Math.max(RADIUS_MIN, Math.min(RADIUS_MAX, n));
    setPrefs({ ...prefs, radiusKm: clamped });
  };

  const onLimitChange = (e) => {
    const raw = e.target.value;
    if (raw === "") {
      setPrefs({ ...prefs, limit: 10 });
      return;
    }
    const n = Number(raw);
    if (!Number.isFinite(n)) return;
    const clamped = Math.max(LIMIT_MIN, Math.min(LIMIT_MAX, n));
    setPrefs({ ...prefs, limit: clamped });
  };

  return (
    <div className="card">
      <h2>Preferences (Breweries)</h2>

      <div className="row">
        <div style={{ flex: 1 }}>
          <label>Latitude (optional)</label>
          <input
            type="number"
            value={prefs.userLat ?? ""}
            onChange={(e) =>
              setPrefs({
                ...prefs,
                userLat: e.target.value === "" ? null : Number(e.target.value)
              })
            }
            placeholder="e.g. 52.5200"
          />
        </div>

        <div style={{ flex: 1 }}>
          <label>Longitude (optional)</label>
          <input
            type="number"
            value={prefs.userLon ?? ""}
            onChange={(e) =>
              setPrefs({
                ...prefs,
                userLon: e.target.value === "" ? null : Number(e.target.value)
              })
            }
            placeholder="e.g. 13.4050"
          />
        </div>
      </div>

      <div style={{ marginTop: 10 }}>
        <label>Brewery types</label>

        {Array.isArray(availableTypes) && availableTypes.length > 0 ? (
          <div style={{ marginTop: 6 }}>
            {availableTypes.map((t) => {
              const key = String(t).toLowerCase();
              const checked = (prefs.preferredTypes || [])
                .map((x) => String(x).toLowerCase())
                .includes(key);

              return (
                <div className="checkbox" key={key}>
                  <input type="checkbox" checked={checked} onChange={() => toggleType(key)} />
                  <span>{key}</span>
                </div>
              );
            })}
          </div>
        ) : (
          <div className="small" style={{ marginTop: 6 }}>
            No types loaded yet. Click “Refresh Breweries” first.
          </div>
        )}
      </div>

      <div style={{ marginTop: 10 }}>
        <label>Name keywords (comma separated, optional)</label>
        <input
          type="text"
          value={prefs.nameKeywordsRaw}
          onChange={(e) => setPrefs({ ...prefs, nameKeywordsRaw: e.target.value })}
          placeholder='e.g. "kindl", "spree", "ale"'
        />
      </div>

      <div style={{ marginTop: 10 }}>
        <label>Radius (km)</label>
        <input
          type="number"
          value={prefs.radiusKm}
          onChange={onRadiusChange}
          min={RADIUS_MIN}
          max={RADIUS_MAX}
          step={0.5}
        />
        <div className="small" style={{ marginTop: 6 }}>
          Radius max in UI: {RADIUS_MAX} km. Backend also applies a safety clamp.
        </div>
      </div>

      {/* NEW: limit control */}
      <div style={{ marginTop: 10 }}>
        <label>Max results (limit)</label>
        <input
          type="number"
          value={prefs.limit ?? 10}
          onChange={onLimitChange}
          min={LIMIT_MIN}
          max={LIMIT_MAX}
          step={1}
        />
        <div className="small" style={{ marginTop: 6 }}>
          Default is 10. You can request more; backend clamps to MAX_TOP_N.
        </div>
      </div>

      <div style={{ marginTop: 10 }} className="checkbox">
        <input type="checkbox" checked={prefs.preferWebsite} onChange={toggleWebsite} />
        <span>Prefer listings with website</span>
      </div>

      <div className="actions" style={{ marginTop: 12 }}>
        <button className="secondary" onClick={onRefreshBreweries} disabled={loading}>
          Refresh Breweries (OpenBreweryDB → Postgres)
        </button>
        <button onClick={onRecommend} disabled={loading}>
          Get Recommendations
        </button>
      </div>

      <div className="small" style={{ marginTop: 10 }}>
        If you do not set location, distance will not be used for radius filtering/scoring.
      </div>
    </div>
  );
};
